---
title: "Homework 4 - ML in genomics: Identifying unknown gene dependency from expression data"
author: "Renan Escalante"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

In this homework, we'll use gene expression data to predict dependency scores for an unknown gene. The goal is to identify the likely dependency gene based on the best predictors of the dependency scores.

## 1. Data Preparation

First, let's load the necessary libraries and data.

```{r load_libraries, message=FALSE, warning=FALSE}
library(tidyverse)
library(tidymodels)

# Load the local dataset
data <- read_csv(here::here("class_4_linear_regression/depmap/dependency_score_to_predict.csv"))

# Display the first few rows and summary of the dataset
head(data)
summary(data)
```

Now, let's prepare the data for modeling.

```{r prepare_data}
# Separate the target variable (dependency score) and predictors
model_data <- data %>%
  select(cell_line = depmap_id, 
         dependency = crispr_dep_map_public_24q2_score_chronos, 
         everything(), 
         -cell_line_name, -primary_disease, -lineage, -lineage_subtype)

# Remove any rows with NA values
model_data <- model_data %>% drop_na()

print(paste("Number of samples:", nrow(model_data)))
print(paste("Number of predictors:", ncol(model_data) - 2))  # Subtract 2 for cell_line and dependency columns
```

## 2. Exploratory Data Analysis

Let's examine the distribution of dependency scores and correlations with gene expression.

```{r eda}
# Distribution of dependency scores
ggplot(model_data, aes(x = dependency)) +
  geom_histogram(bins = 30) +
  ggtitle("Distribution of Dependency Scores")

# Correlations between dependency and gene expression
correlations <- model_data %>%
  select(-cell_line) %>%
  cor() %>%
  as.data.frame() %>%
  rownames_to_column("gene") %>%
  select(gene, correlation = dependency) %>%
  arrange(desc(abs(correlation)))

top_correlated_genes <- head(correlations, 10)
print(top_correlated_genes)
```

## 3. Model Building

Now, let's split the data, create a recipe, and fit a linear regression model.

```{r model_building}
# Split data
set.seed(123)
data_split <- initial_split(model_data, prop = 0.8, strata = dependency)
train_data <- training(data_split)
test_data <- testing(data_split)

# Create recipe
recipe <- recipe(dependency ~ ., data = train_data) %>%
  update_role(cell_line, new_role = "ID") %>%
  step_normalize(all_predictors())

# Specify model
lm_spec <- linear_reg() %>%
  set_engine("lm")

# Create workflow
workflow <- workflow() %>%
  add_recipe(recipe) %>%
  add_model(lm_spec)

# Fit model
fit <- workflow %>%
  fit(data = train_data)

# Make predictions
predictions <- fit %>%
  predict(test_data) %>%
  bind_cols(test_data)

# Evaluate model
metrics <- predictions %>%
  metrics(truth = dependency, estimate = .pred)

print(metrics)
```

## 4. Model Interpretation

Let's examine the coefficients to identify top predictors.

```{r model_interpretation}
# Extract coefficients
coefficients <- fit %>%
  extract_fit_parsnip() %>%
  tidy() %>%
  arrange(desc(abs(estimate)))

print(head(coefficients, 10))

# Visualize actual vs predicted values
ggplot(predictions, aes(x = dependency, y = .pred)) +
  geom_point() +
  geom_abline(color = "red") +
  ggtitle("Actual vs Predicted Dependency Scores")
```

## 5. Feature Importance

Let's calculate feature importance using permutation importance.

```{r feature_importance}
library(vip)

# Calculate variable importance
importance <- fit %>%
  extract_fit_parsnip() %>%
  vip(method = "permute", target = "dependency", metric = "rmse", 
      pred_wrapper = predict, train = train_data)

importance
```

## 6. Identifying the Likely Dependency Gene

Based on the feature importance and coefficient analysis, we can make an educated guess about the likely dependency gene.



## Conclusion

In this analysis, we've built a linear regression model to predict dependency scores from gene expression data using a local dataset. We've gone through the process of data preparation, exploratory data analysis, model building, interpretation, and feature importance analysis.

The model's performance and feature importance analysis have helped us identify the gene that is most predictive of the dependency scores. This gene is likely to be the dependency gene itself or a gene closely related to it in function or regulatory pathway.

To further investigate this:

1. Research the top predictive gene and its known interactions or relationships with other genes.
2. Look for genes in similar pathways or with similar functions to the top predictive gene.
3. Consider the biological plausibility of this gene being a critical dependency in cancer cells.
4. If possible, validate this prediction experimentally or with additional datasets.

Remember, while this analysis provides a strong indication, definitive identification of the dependency gene would require additional biological validation.